<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.landleaf.homeauto.center.device.model.mapper.HomeAutoFamilyMapper">

    <resultMap id="familyForAppBO" type="com.landleaf.homeauto.center.device.model.bo.FamilyForAppBO">
        <result column="family_id" property="familyId"/>
        <result column="family_name" property="familyName"/>
        <result column="last_checked" property="lastChecked"/>
    </resultMap>

    <resultMap id="familyInfoBO" type="com.landleaf.homeauto.center.device.model.bo.FamilyInfoBO">
        <result column="family_id" property="familyId"/>
        <result column="family_code" property="familyCode"/>
    </resultMap>


    <resultMap id="floorInfoVO" type="com.landleaf.homeauto.center.device.model.vo.FloorInfoVO">
        <result column="floor" property="floor"/>
        <collection property="rooms" ofType="com.landleaf.homeauto.center.device.model.vo.RoomInfoVO">
            <result column="id" property="name"/>
            <result column="name" property="name"/>
            <collection property="devices" ofType="com.landleaf.homeauto.center.device.model.vo.DeviceInfoVO">
                <result column="did" property="id"/>
                <result column="dname" property="name"/>
                <result column="icon" property="icon"/>
            </collection>
        </collection>
    </resultMap>

    <select id="getFamilyByUserId" resultMap="familyForAppBO">
        SELECT
            family.id AS family_id,
            family.name AS family_name,
            family_user.last_checked AS last_checked
        FROM home_auto_family family
        LEFT JOIN family_user ON family_user.family_id = family.id
        WHERE family_user.user_id = #{userId}
        ORDER BY family.create_time ASC
    </select>

    <select id="getWeatherCodeByFamilyId" resultType="java.lang.String">
        SELECT
            area.weather_code
        FROM
            home_auto_area AS area
        LEFT JOIN home_auto_realestate AS realestate ON realestate.city_code = area.code
        LEFT JOIN home_auto_project AS project ON project.realestate_id = realestate.id
        LEFT JOIN project_building AS building ON building.project_id = project.id
        LEFT JOIN project_building_unit AS unit ON unit.building_id = building.id
        LEFT JOIN home_auto_family AS family ON family.unit_id = unit.id
        WHERE family.id = #{familyId}
    </select>

    <select id="getFamilyInfoByTerminalMac" resultMap="familyInfoBO">
        SELECT
            family.id AS family_id,
            family.code AS family_code
        FROM
            home_auto_family AS family
        LEFT JOIN family_terminal AS terminal ON terminal.family_id = family.id
        WHERE terminal.type = #{type} AND terminal.mac = #{mac}
    </select>
    <select id="getListFamilyInfo" resultType="com.landleaf.homeauto.center.device.model.vo.MyFamilyInfoVO">
        SELECT
            f.ID,
            f.NAME,
            re.area,
            fu.type
        FROM
            home_auto_family f
            INNER JOIN home_auto_realestate re ON re.ID = f.realestate_id
            LEFT JOIN family_user fu ON fu.family_id = f.ID
        WHERE
            fu.user_id = #{userId}
    </select>
    <select id="getMyFamilyInfo" resultMap="floorInfoVO">
        SELECT
            f.FLOOR,
            r.ID,
            r.NAME,
            d.ID AS did,
            d.NAME AS dname
        FROM
            family_floor f
            LEFT JOIN family_room r ON r.floor_id = f.ID
            LEFT JOIN family_device d ON d.room_id = r.ID
        WHERE
            f.family_id = #{familyId}
    </select>
    <select id="getMyFamilyUserInfo"
            resultType="com.landleaf.homeauto.center.device.model.vo.FamilyUserInfoVO">
      	SELECT
            fu.id as memberId,
            fu.user_id,
            fu.type
        FROM
            family_user fu
        WHERE
            fu.family_id = #{familyId}
    </select>
    <select id="getFamilyInfoForSobotById"
            resultType="com.landleaf.homeauto.center.device.model.dto.FamilyInfoForSobotDTO">

        SELECT
            f.id AS familyId,
            f.NAME AS familyName,
            f.realestate_id AS realestateId,
            f.project_id AS projectId,
            f.building_id AS buildingId,
            f.unit_id AS unitId,
            f.room_no AS roomNo,
            P.NAME AS projectName,
            r.NAME AS realestateName,
            pb.NAME AS buildingName,
            pbu.NAME AS unitName
        FROM
            home_auto_family f
            LEFT JOIN home_auto_realestate r ON f.realestate_id = r.
            ID LEFT JOIN home_auto_project P ON f.project_id = P.
            ID LEFT JOIN project_building pb ON f.building_id = pb.
            ID LEFT JOIN project_building_unit pbu ON f.unit_id = pbu.ID
        WHERE
            f.id = #{familyId}

    </select>
</mapper>
