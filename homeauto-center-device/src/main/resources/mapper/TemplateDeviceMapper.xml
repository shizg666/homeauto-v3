<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.landleaf.homeauto.center.device.model.mapper.TemplateDeviceMapper">

    <!--添加场景 家庭暖通设备信息-->
    <resultMap id="sceneHvacDeviceVO" type="com.landleaf.homeauto.center.device.model.vo.scene.SceneHvacDeviceVO">
        <id column="code" property="categoyCode"/>
        <result column="deviceSn" property="deviceSn"/>
        <result column="name" property="name"/>
        <collection property="windSpeeds" ofType="com.landleaf.homeauto.center.device.model.vo.SelectedVO">
            <result column="attrName" property="label"/>
            <result column="attrCode" property="value"/>
        </collection>
    </resultMap>

    <!--新增场景  户型楼层房间非暖通设备 -->
    <resultMap id="sceneFloorVO" type="com.landleaf.homeauto.center.device.model.vo.scene.SceneFloorVO">
        <id column="fname" property="name"/>
        <collection property="rooms" ofType="com.landleaf.homeauto.center.device.model.vo.scene.SceneRoomVO">
            <result column="rname" property="name"/>
            <collection property="devices" ofType="com.landleaf.homeauto.center.device.model.vo.scene.SceneDeviceVO">
                <result column="deviceSn" property="deviceSn"/>
                <result column="id" property="id"/>
                <result column="pname" property="productName"/>
                <result column="product_id" property="productId"/>
            </collection>
        </collection>
    </resultMap>

    <update id="updateBatchSort">
        <foreach collection="sortNoBOS" item="item" index="index" open="" close="" separator=";">
            update house_template_device
            <set>
                sort_no = #{item.sortNo}
            </set>
            where id = #{item.id}
        </foreach>
    </update>

    <select id="existParam" resultType="java.lang.Integer">
          SELECT COUNT
                (1)
            FROM
                house_template_device
            WHERE
            room_id = #{roomId}
            <if test="name != null and name != ''">
                and NAME = #{name}
            </if>
            <if test="sn !=  null and sn !=  ''">
                and sn = #{sn}
            </if>
        LIMIT 1
    </select>

    <select id="countDeviceByRoomIds"
            resultType="com.landleaf.homeauto.center.device.model.vo.project.CountBO">
        SELECT
            d.room_id as id,
            COUNT ( 1 )
        FROM
            house_template_device d
        where
            d.room_id IN
            <foreach collection="roomIds" open="(" close=")" separator="," item="room">
                #{room}
            </foreach>
            GROUP BY
            d.room_id
    </select>

    <select id="getListByRoomId"
            resultType="com.landleaf.homeauto.center.device.model.vo.project.TemplateDevicePageVO">
        SELECT
            d.ID,
            d.NAME,
            d.sn,
            d.sort_no,
            d.port,
            d.baud_rate,
            d.check_mode,
            d.data_bit,
            d.stop_bit,
            P.ID AS productId,
            P.NAME AS productName,
            dc.NAME AS brandName,
            P.brand_code,
            P.model,
            C.ID AS categoryId,
            C.NAME AS categoryName,
            T.ID AS terminalId,
            T.NAME AS terminalName
        FROM
            house_template_device d
            INNER JOIN home_auto_product P ON d.product_id = P.
            ID INNER JOIN home_auto_category C ON P.category_id = C.
            ID INNER JOIN house_template_terminal T ON d.terminal_id = T.
            ID LEFT JOIN sys_dic_tag dc ON P.brand_code = dc.VALUE
        WHERE
            dc.dic_code = 'brand'
            AND d.room_id = #{roomId}
            order by d.sort_no asc
    </select>

    <select id="getListSortNoBoGT" resultType="com.landleaf.homeauto.center.device.model.vo.project.SortNoBO">
          SELECT
        d.ID,
        d.sort_no
        FROM
            house_template_device d
        WHERE
            d.sort_no > #{sortNo}
            and d.room_id = #{roomId}
    </select>

    <select id="getListSortNoBoLT" resultType="com.landleaf.homeauto.center.device.model.vo.project.SortNoBO">
           SELECT
        d.ID,
        d.sort_no
        FROM
            house_template_device d
        WHERE
            d.sort_no &lt; #{sortNo}
            and d.room_id = #{roomId}
    </select>

    <select id="getListPanel" resultType="java.lang.String">
select d.sn  from house_template_device d ,home_auto_category c where d.category_id = c.id  and c.code = '6'  and d.house_template_id = #{templateId}
    </select>

    <select id="getListPanelSelects" resultType="com.landleaf.homeauto.center.device.model.vo.device.PanelBO">
        SELECT
            d.sn,
            r.NAME as roomName,
            f.NAME AS floorName
        FROM
            house_template_device d,
            home_auto_category C,
            house_template_room r,
            house_template_floor f
        WHERE
            d.category_id = C.ID
            AND d.room_id = r.ID
            AND r.floor_id = f.ID
            AND C.code = '6'
            AND d.house_template_id = #{templateId}
    </select>

    <select id="getListHvacInfo"
            resultMap="sceneHvacDeviceVO">
            SELECT
                d.sn as deviceSn,
                c.code,
                d.name,
                pai.name as attrName,
                pai.code as attrCode
            FROM
                house_template_device d,
                home_auto_category c,
                home_auto_product p,
                product_attribute pa,
                product_attribute_info pai
            WHERE
                d.category_id = C.ID
                and d.product_id = p.id
                and pa.product_id = p.id
                and pai.product_attribute_id = pa.id
                and p.hvac_flag = 1
                and pa.code = 'wind_speed'
                AND d.house_template_id = #{templateId}
    </select>
    <select id="getPanelSettingTemperature"
            resultType="com.landleaf.homeauto.center.device.model.vo.scene.AttributeScopeVO">
        SELECT
            pais.max,
            pais.min,
            pais.step,
            pais.precision
        FROM
            house_template_device d,
            home_auto_category c,
            home_auto_product p,
            product_attribute pa,
            product_attribute_info_scope pais

        WHERE
            d.category_id = C.ID
            and d.product_id = p.id
            and pa.product_id = p.id
            and pais.parent_id = pa.id
            and pais.type = 1
            and pa.code = 'setting_temperature'
            and c.code = '6'
            AND d.house_template_id = #{templateId}
            limit 1
    </select>
    <select id="getListdeviceInfo"
            resultMap="sceneFloorVO">
        SELECT
            f.name as fname,
            r.name as rname,
            d.name as dname,
            d.sn,
            d.id,
            d.product_id,
            p.name as pname
        FROM
            house_template_floor f
            left join house_template_room r on f.id = r.floor_id
            left join house_template_device d on d.room_id = r.id
            left join home_auto_product p on p.id = d.product_id
        WHERE
            p.hvac_flag = 0
            and d.house_template_id = #{templateId}
    </select>
    <select id="getListDevice" resultType="com.landleaf.homeauto.center.device.model.vo.scene.SceneDeviceVO">

         SELECT
            f.name as floorName,
            r.name as roomName,
            d.name,
            d.sn as deviceSn,
            d.id,
            d.product_id,
            p.name as productName
        FROM
            house_template_floor f
            left join house_template_room r on f.id = r.floor_id
            left join house_template_device d on d.room_id = r.id
            left join home_auto_product p on p.id = d.product_id
        WHERE
            p.hvac_flag = 0
            and d.house_template_id = #{templateId}
    </select>


</mapper>
