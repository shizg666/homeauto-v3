<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.landleaf.homeauto.center.device.model.mapper.FamilySceneMapper">

    <!--  场景暖通配置  -->
    <resultMap id="webSceneDetailHvacConfigVO" type="com.landleaf.homeauto.center.device.model.vo.scene.WebSceneDetailHvacConfigVO">
        <result column="device_sn" property="deviceSn"/>
        <result column="syswitch" property="switchVal"/>
        <collection property="hvacActionDTOs" ofType="com.landleaf.homeauto.center.device.model.vo.scene.WebSceneDetailHvacActionDTO">
            <result column="mode_val" property="modeVal"/>
            <result column="wind_val" property="windVal"/>
            <result column="room_flag" property="roomFlag"/>
            <result column="switch_val" property="switchVal"/>
            <result column="temperature_val" property="temperatureVal"/>
            <collection property="panelActionDTOs" ofType="com.landleaf.homeauto.center.device.model.vo.scene.WebSceneHvacPanelActionDTO">
                <result column="pswitch" property="switchVal"/>
                <result column="ptemperature" property="temperatureVal"/>
                <result column="psn" property="deviceSn"/>
            </collection>
        </collection>
    </resultMap>


    <!--同步场景  -->
    <resultMap id="syncSceneInfoDTO" type="com.landleaf.homeauto.common.domain.dto.sync.SyncSceneInfoDTO">
        <result column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="upateFlag" property="upateFlag"/>
        <collection property="actions" ofType="com.landleaf.homeauto.common.domain.dto.sync.SyncSceneDTO">
            <result column="device_sn" property="sn"/>
            <collection property="attrs" ofType="com.landleaf.homeauto.common.domain.dto.sync.SyncSceneActionDTO">
                <result column="val" property="attrValue"/>
                <result column="product_attribute_code" property="attrTag"/>
            </collection>
        </collection>
    </resultMap>



    <!--  场景对象  -->
    <resultMap id="sceneForApp" type="com.landleaf.homeauto.center.device.model.bo.FamilySceneBO">
        <id column="scene_id" property="sceneId"/>
        <result column="scene_name" property="sceneName"/>
        <result column="scene_icon" property="sceneIcon"/>
        <result column="scene_index" property="index"/>
    </resultMap>

    <select id="getCommonScenesByFamilyId" parameterType="java.lang.String" resultMap="sceneForApp">
        SELECT
            scene.id AS scene_id,
            scene.name AS scene_name,
            scene.icon AS scene_icon,
            ROW_NUMBER() OVER (ORDER BY common_scene.create_time ASC) AS scene_index
        FROM family_common_scene AS common_scene
        LEFT JOIN family_scene AS scene ON scene.id = common_scene.scene_id
        WHERE common_scene.family_id = #{familyId}
    </select>

    <select id="getAllScenesByFamilyId" parameterType="java.lang.String" resultMap="sceneForApp">
        SELECT
            scene.id AS scene_id,
            scene.name AS scene_name,
            scene.icon AS scene_icon,
            ROW_NUMBER() OVER (ORDER BY scene.create_time ASC) AS scene_index
        FROM family_scene AS scene
        WHERE scene.family_id = #{familyId}
    </select>

    <select id="getListScene"
            resultType="com.landleaf.homeauto.center.device.model.vo.scene.family.FamilyScenePageVO">
       select s.id,s.name,s.update_flag_app,s.update_flag_screen from  family_scene  s where s.family_id = #{familyId}
    </select>

    <select id="getSceneDeviceAction"
            resultType="com.landleaf.homeauto.center.device.model.vo.scene.WebSceneDetailDeviceActionBO">
        SELECT
            f.NAME AS floorMame,
            r.NAME AS roomName,
            d.id as deviceId,
            d.name as deviceName,
            d.product_id,
            sa.device_sn ,
            sa.val,
            sa.product_attribute_id as attributeId,
            C.code
        FROM

            family_scene_action sa,
            family_device d,
            family_room r,
            family_floor f,
            home_auto_category C
        WHERE
            sa.scene_id = #{id}
            and d.family_id = #{familyId}
            AND sa.device_sn = d.sn
            AND d.category_id = C.ID
            AND d.room_id = r.ID
            AND r.floor_id = f.ID
    </select>

    <select id="getListhvacCinfig"
            resultMap="webSceneDetailHvacConfigVO">
          SELECT
        		hc.device_sn,
                hc.switch_val as syswitch,
                ha.mode_val,
                ha.wind_val,
                ha.room_flag,
                ha.switch_val,
                ha.temperature_val,
                hp.device_sn psn,
                hp.switch_val as pswitch,
                hp.temperature_val as ptemperature
            FROM
				family_scene_hvac_config hc
                left join family_scene_hvac_action ha on hc.id = ha.hvac_config_id
                left join family_scene_hvac_panel_action hp on ha.id = hp.hvac_action_id
            WHERE
             hc.scene_id = #{sceneId}
    </select>

    <select id="getListSyncScene" resultMap="syncSceneInfoDTO">
        	SELECT
                s.ID,
                s.NAME,
                s.update_flag_screen AS upateFlag,
                sa.device_sn,
                sa.val,
                sa.product_attribute_code
            FROM
                family_scene s
                LEFT JOIN family_scene_action sa ON sa.scene_id = s.ID
            WHERE
                s.family_id = ''
    </select>

</mapper>
